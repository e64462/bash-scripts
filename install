#!/bin/bash

set -euo pipefail

# Ensure we're running as root
if [[ $EUID -ne 0 ]]; then
	echo "This file must be called with sudo privileges"
	exit 1
fi

# Source files and target locations
declare -A FILES=(
	[backUP]="/usr/local/bin/backUP"
	[args2array]="/usr/local/lib/backUP/args2array"
	[logging]="/usr/local/lib/backUP/logging"
)

CONFIG_DIR="/usr/local/etc/backUP"
CONFIG_FILES=(
	"$CONFIG_DIR/backUP.conf"
	"$CONFIG_DIR/backup.txt"
)

# Create necessary directories
mkdir -p /usr/local/lib/backUP "$CONFIG_DIR"

# Install files if changed
for src in "${!FILES[@]}"; do
	dst="${FILES[$src]}"
	if [[ -e "$dst" ]]; then
		if cmp -s "$src" "$dst"; then
			echo "✓ $dst is up to date, skipping"
			continue
		else
			read -p "⚠ $dst differs from source. Overwrite? [y/N] " ans
			[[ "$ans" =~ ^[Yy]$ ]] || { echo "Skipping $dst"; continue; }
		fi
	else
		echo "→ Installing $dst"
	fi
	install -o root -g root -m 755 "$src" "$dst"
done

# Ensure config files exist with correct perms
for file in "${CONFIG_FILES[@]}"; do
	if [[ ! -e "$file" ]]; then
		touch "$file"
		echo "→ Created $file"
	fi
	chmod 660 "$file"
	chown root:root "$file"
done
